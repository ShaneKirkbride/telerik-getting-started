@page "/config-upload"
@using ConfigurationService.Application
@using ConfigurationService.Contracts
@inject ITaggedConfigParser Parser
@inject IConfigDistributor Distributor

<h3>Upload Machine Configuration (XML)</h3>

<InputFile OnChange="OnFileSelected" accept=".xml" />
@if (!string.IsNullOrEmpty(_status))
{
    <p><em>@_status</em></p>
}

@if (_config is not null)
{
    <hr />
    <h5>Parsed Identity</h5>
    <ul>
        <li><strong>Name:</strong> @_config.Identity.Name</li>
        <li><strong>Location:</strong> @_config.Identity.Location</li>
        <li><strong>Version:</strong> @_config.Identity.Version</li>
    </ul>

    <button class="btn btn-primary" @onclick="PushAll">Push to Agents</button>

    @if (_pushResults is not null)
    {
        <h6 class="mt-3">Push Results</h6>
        <table class="table table-sm">
            <thead><tr><th>Agent</th><th>Success</th></tr></thead>
            <tbody>
                @foreach (var kvp in _pushResults)
                {
                    <tr><td>@kvp.Key</td><td>@kvp.Value</td></tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private MachineConfig? _config;
    private string? _status;
    private IReadOnlyDictionary<string, bool>? _pushResults;

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        _status = "Parsing...";
        _pushResults = null;
        try
        {
            await using var xml = e.File.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            // Optional XSD validation if you ship it with the app
            using var xsd = await TryOpenXsdAsync("Config/MachineConfig.xsd");
            _config = await Parser.ParseAsync(xml, xsd);
            _status = "Parsed successfully.";
        }
        catch (Exception ex)
        {
            _config = null;
            _status = $"Error: {ex.Message}";
        }
    }

    private async Task PushAll()
    {
        if (_config is null) return;
        _status = "Pushing...";
        _pushResults = await Distributor.DistributeAsync(_config);
        _status = "Push completed.";
    }

    private async Task<Stream?> TryOpenXsdAsync(string relativePath)
    {
        try
        {
            var path = System.IO.Path.Combine(FileSystem.AppDataDirectory, relativePath); // MAUI sandbox
            if (File.Exists(path)) return File.OpenRead(path);

            // As a fallback, try loading from assembly resource if you embed it.
            var asm = typeof(Program).Assembly;
            var name = asm.GetManifestResourceNames().FirstOrDefault(n => n.EndsWith("MachineConfig.xsd"));
            return name is null ? null : asm.GetManifestResourceStream(name);
        }
        catch { return null; }
    }
}
